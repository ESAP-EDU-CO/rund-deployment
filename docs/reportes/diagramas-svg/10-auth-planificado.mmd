sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ Usuario
    participant MGP as ğŸ–¥ï¸ RUND-MGP
    participant AUTH as ğŸ”‘ RUND-AUTH
    participant ENTRA as ğŸ”· Microsoft Entra ID
    participant API as âš™ï¸ RUND-API
    participant CORE as ğŸ“ RUND-CORE

    Note over U,CORE: âœ… FLUJO PLANIFICADO: OAuth 2.0 + JWT

    U->>MGP: 1. Accede al portal
    MGP->>AUTH: 2. Verificar sesiÃ³n
    AUTH-->>MGP: 3. No hay sesiÃ³n vÃ¡lida
    MGP->>U: 4. Redirige a login

    U->>AUTH: 5. Inicia login
    AUTH->>ENTRA: 6. Authorization Request
    ENTRA->>U: 7. PÃ¡gina de login Microsoft
    U->>ENTRA: 8. Credenciales corporativas
    ENTRA->>AUTH: 9. Authorization Code
    AUTH->>ENTRA: 10. Token Request
    ENTRA-->>AUTH: 11. ID Token + Access Token

    AUTH->>AUTH: 12. Genera JWT interno
    Note right of AUTH: JWT incluye sub, roles, exp, aud

    AUTH-->>MGP: 13. JWT Token
    MGP->>MGP: 14. Almacena token (memoria)
    MGP-->>U: 15. SesiÃ³n iniciada

    U->>MGP: 16. Solicita datos
    MGP->>API: 17. GET /api/v2/profesores/{cedula} Authorization: Bearer JWT

    API->>API: 18. Valida JWT
    Note right of API: Verifica Firma, ExpiraciÃ³n, Audiencia, Roles

    API->>CORE: 19. GET /OpenKM/... Authorization: Basic env vars
    CORE-->>API: 20. Datos
    API-->>MGP: 21. JSON Response
    MGP-->>U: 22. Muestra informaciÃ³n

    Note over U,CORE: ğŸ”„ Refresh Token cada 15 min
